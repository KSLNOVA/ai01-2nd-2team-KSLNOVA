<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <title>ğŸ‹ï¸ ìš´ë™ ìì„¸ AI Agent</title>
    <script type="module">
        import { PoseLandmarker, FilesetResolver, DrawingUtils } from "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.3";

        let video, canvas, ctx, poseLandmarker, drawingUtils;
        let frameIndex = 1, isRunning = false;
        let startTime = null;
        let currentExercise = "squat";
        let smoothedLandmarks = null;

        // ìŠ¤ë¬´ë”© ë° ì„ê³„ê°’ ìƒìˆ˜
        const SMOOTHING = 0.7, VIS_TH = 0.7;

        // ===== ìŠ¤ì¿¼íŠ¸ ìƒíƒœ =====
        let cycleState = "STANDING", repCount = 0, minKneeAngle = 180, capturedImage = null;
        let isProcessingFeedback = false;
        const STANDING_TH = 160, SQUAT_TH = 110;

        // ===== í”Œë­í¬ ìƒíƒœ =====
        let plankState = "WAITING"; // WAITING, HOLDING
        let holdStartTime = null, totalHoldTime = 0;
        let lastPlankCaptureTime = 0;
        const PLANK_CAPTURE_INTERVAL = 5000; // 5ì´ˆë§ˆë‹¤ ìº¡ì²˜
        const PLANK_GOOD_MIN = 160, PLANK_GOOD_MAX = 185; // ì¢‹ì€ ìì„¸ ë²”ìœ„

        // ===== ìˆ„ë”í”„ë ˆìŠ¤ ìƒíƒœ =====
        let pressState = "READY"; // READY, PRESSING, TOP
        let minElbowAngle = 180, maxElbowAngle = 0;
        const PRESS_READY_TH = 110; // íŒ”ê¿ˆì¹˜ê°€ 110Â° ì´í•˜ë©´ ì¤€ë¹„ ìì„¸
        const PRESS_TOP_TH = 155; // íŒ”ê¿ˆì¹˜ê°€ 155Â° ì´ìƒì´ë©´ ì™„ë£Œ

        // ë…¹í™” ë° í”¼ë“œë°±
        let mediaRecorder = null;
        let recordedChunks = [];
        let feedbackHistory = [];

        // ìŠ¤ë¬´ë”© í•¨ìˆ˜
        function smooth(lm) {
            if (!smoothedLandmarks) { smoothedLandmarks = lm.map(l => ({ ...l })); return smoothedLandmarks; }
            for (let i = 0; i < lm.length; i++) {
                smoothedLandmarks[i].x = smoothedLandmarks[i].x * (1 - SMOOTHING) + lm[i].x * SMOOTHING;
                smoothedLandmarks[i].y = smoothedLandmarks[i].y * (1 - SMOOTHING) + lm[i].y * SMOOTHING;
                smoothedLandmarks[i].z = smoothedLandmarks[i].z * (1 - SMOOTHING) + lm[i].z * SMOOTHING;
            }
            return smoothedLandmarks;
        }

        // ê°€ì‹œì„± ì²´í¬ (ìŠ¤ì¿¼íŠ¸ìš© - í•˜ì²´)
        function checkVisibleSquat(lm) {
            for (const i of [23, 24, 25, 26, 27, 28]) {
                if (!lm[i] || lm[i].y > 1 || lm[i].y < 0) return false;
                if (lm[i].visibility !== undefined && lm[i].visibility < VIS_TH) return false;
            }
            return true;
        }

        // ê°€ì‹œì„± ì²´í¬ (í”Œë­í¬ìš© - ì „ì‹ )
        function checkVisiblePlank(lm) {
            // ì–´ê¹¨(11,12), ì—‰ë©ì´(23,24), ë°œëª©(27,28)
            for (const i of [11, 12, 23, 24, 27, 28]) {
                if (!lm[i] || lm[i].y > 1 || lm[i].y < 0) return false;
                if (lm[i].visibility !== undefined && lm[i].visibility < VIS_TH) return false;
            }
            return true;
        }

        // ê°ë„ ê³„ì‚°
        function calcAngle(a, b, c) {
            const AB = [a.x - b.x, a.y - b.y], CB = [c.x - b.x, c.y - b.y];
            const dot = AB[0] * CB[0] + AB[1] * CB[1];
            const mag = Math.hypot(...AB) * Math.hypot(...CB);
            return mag === 0 ? 180 : Math.acos(Math.max(-1, Math.min(1, dot / mag))) * (180 / Math.PI);
        }

        async function initCamera() {
            video = document.getElementById("video");
            canvas = document.getElementById("canvas");
            ctx = canvas.getContext("2d");
            const stream = await navigator.mediaDevices.getUserMedia({ video: { width: 480, height: 360 } });
            video.srcObject = stream;
            await video.play();
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
        }

        async function initPose() {
            const vision = await FilesetResolver.forVisionTasks("https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.3/wasm");
            poseLandmarker = await PoseLandmarker.createFromOptions(vision, {
                baseOptions: { modelAssetPath: "https://storage.googleapis.com/mediapipe-models/pose_landmarker/pose_landmarker_full/float16/1/pose_landmarker_full.task" },
                runningMode: "VIDEO", numPoses: 1
            });
            drawingUtils = new DrawingUtils(ctx);
        }

        function speak(text) { speechSynthesis.cancel(); const u = new SpeechSynthesisUtterance(text); u.lang = "ko-KR"; u.rate = 1.1; speechSynthesis.speak(u); }

        async function sendImage(img, count, holdTime = 0) {
            try {
                const res = await fetch("http://localhost:8003/analyze-image", {
                    method: "POST", headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ image: img, rep_count: count, exercise_type: currentExercise, hold_time: holdTime })
                });
                return (await res.json()).feedback;
            } catch (e) { return null; }
        }

        // ìŠ¤ì¿¼íŠ¸ ì™„ë£Œ ì²˜ë¦¬
        async function onSquatComplete() {
            if (isProcessingFeedback || !capturedImage) return;
            isProcessingFeedback = true;
            repCount++;
            document.getElementById("repCount").innerText = repCount;
            document.getElementById("status").innerText = "ğŸ“¸ ë¶„ì„ ì¤‘...";
            document.getElementById("capturedImg").src = capturedImage;
            document.getElementById("capturedImg").style.display = "block";
            const fb = await sendImage(capturedImage, repCount);
            if (fb) {
                document.getElementById("feedback").innerText = fb;
                speak(fb);
                document.getElementById("status").innerText = "ğŸ”´ " + repCount + "íšŒ!";
                feedbackHistory.push({ rep: repCount, feedback: fb });
            }
            capturedImage = null; minKneeAngle = 180; isProcessingFeedback = false;
        }

        // í”Œë­í¬ í”¼ë“œë°± ì²˜ë¦¬
        async function onPlankCapture() {
            if (isProcessingFeedback) return;
            isProcessingFeedback = true;

            const capturedImg = canvas.toDataURL("image/jpeg", 0.8);
            document.getElementById("capturedImg").src = capturedImg;
            document.getElementById("capturedImg").style.display = "block";
            document.getElementById("status").innerText = "ğŸ“¸ ë¶„ì„ ì¤‘...";

            const fb = await sendImage(capturedImg, 0, totalHoldTime);
            if (fb) {
                document.getElementById("feedback").innerText = fb;
                speak(fb);
                feedbackHistory.push({ time: totalHoldTime, feedback: fb });
            }
            document.getElementById("status").innerText = "ğŸ”´ ìœ ì§€ ì¤‘...";
            isProcessingFeedback = false;
        }

        // ìŠ¤ì¼ˆë ˆí†¤ ê·¸ë¦¬ê¸°
        function drawSkeleton(lm, indices, connections) {
            ctx.strokeStyle = "#00d4ff"; ctx.lineWidth = 3;
            connections.forEach(([a, b]) => {
                if (lm[a].y >= 0 && lm[a].y <= 1 && lm[b].y >= 0 && lm[b].y <= 1) {
                    ctx.beginPath(); ctx.moveTo(lm[a].x * canvas.width, lm[a].y * canvas.height);
                    ctx.lineTo(lm[b].x * canvas.width, lm[b].y * canvas.height); ctx.stroke();
                }
            });
            indices.filter(i => lm[i].y >= 0 && lm[i].y <= 1).forEach(i => {
                ctx.beginPath(); ctx.arc(lm[i].x * canvas.width, lm[i].y * canvas.height, 5, 0, 2 * Math.PI);
                ctx.fillStyle = "#00ff88"; ctx.fill();
            });
        }

        // ===== ìŠ¤ì¿¼íŠ¸ ë¡œì§ =====
        function processSquat(lm) {
            if (!checkVisibleSquat(lm)) {
                document.getElementById("status").innerText = "âš ï¸ ì „ì‹ ì´ ë³´ì´ë„ë¡";
                return;
            }

            const idx = [11, 12, 23, 24, 25, 26, 27, 28];
            const connections = [[11, 12], [11, 23], [12, 24], [23, 24], [23, 25], [24, 26], [25, 27], [26, 28]];
            drawSkeleton(lm, idx, connections);

            // ë¬´ë¦ ê°ë„ ê³„ì‚°
            const hip = lm[23].z < lm[24].z ? lm[23] : lm[24];
            const knee = lm[25].z < lm[26].z ? lm[25] : lm[26];
            const ankle = lm[27].z < lm[28].z ? lm[27] : lm[28];
            const angle = calcAngle(hip, knee, ankle);

            // ì‚¬ì´í´ ìƒíƒœ ë¨¸ì‹ 
            if (cycleState === "STANDING" && angle < STANDING_TH - 10) {
                cycleState = "SQUATTING"; minKneeAngle = angle;
                document.getElementById("status").innerText = "â¬‡ï¸ í•˜ê°•";
            }
            else if (cycleState === "SQUATTING") {
                if (angle < minKneeAngle) {
                    minKneeAngle = angle;
                    if (angle < SQUAT_TH) {
                        capturedImage = canvas.toDataURL("image/jpeg", 0.8);
                        document.getElementById("status").innerText = "ğŸ“¸ ìº¡ì²˜!";
                    }
                }
                if (angle > minKneeAngle + 20 && minKneeAngle < SQUAT_TH) {
                    cycleState = "RISING";
                    document.getElementById("status").innerText = "â¬†ï¸ ìƒìŠ¹";
                }
                if (angle > STANDING_TH) {
                    cycleState = "STANDING"; minKneeAngle = 180; capturedImage = null;
                    document.getElementById("status").innerText = "âŒ ë” ê¹Šì´";
                }
            }
            else if (cycleState === "RISING" && angle > STANDING_TH) {
                cycleState = "STANDING";
                onSquatComplete();
            }
        }

        // ===== í”Œë­í¬ ë¡œì§ =====
        function processPlank(lm) {
            if (!checkVisiblePlank(lm)) {
                document.getElementById("status").innerText = "âš ï¸ ì „ì‹ ì´ ë³´ì´ë„ë¡ (ì˜†ëª¨ìŠµ ê¶Œì¥)";
                // í”Œë­í¬ ìì„¸ ì´íƒˆ ì‹œ ìƒíƒœ ë¦¬ì…‹
                if (plankState === "HOLDING") {
                    plankState = "WAITING";
                    holdStartTime = null;
                }
                return;
            }

            // í”Œë­í¬ìš© ìŠ¤ì¼ˆë ˆí†¤ (ìƒì²´ í¬í•¨)
            const idx = [11, 12, 13, 14, 23, 24, 25, 26, 27, 28];
            const connections = [[11, 12], [11, 13], [12, 14], [11, 23], [12, 24], [23, 24], [23, 25], [24, 26], [25, 27], [26, 28]];
            drawSkeleton(lm, idx, connections);

            // ì–´ê¹¨-ì—‰ë©ì´-ë°œëª© ê°ë„ (ëª¸ ì •ë ¬)
            // ê°€ê¹Œìš´ ìª½ ì‚¬ìš© (z ì¢Œí‘œ ë¹„êµ)
            const shoulder = lm[11].z < lm[12].z ? lm[11] : lm[12];
            const hip = lm[23].z < lm[24].z ? lm[23] : lm[24];
            const ankle = lm[27].z < lm[28].z ? lm[27] : lm[28];
            const bodyAngle = calcAngle(shoulder, hip, ankle);

            // ê°ë„ í‘œì‹œ
            ctx.fillStyle = "#ffcc00";
            ctx.font = "16px Arial";
            ctx.fillText(`Body: ${bodyAngle.toFixed(1)}Â°`, 10, 30);

            // ìì„¸ í”¼ë“œë°±
            let postureFeedback = "";
            let isGoodPosture = false;

            if (bodyAngle < PLANK_GOOD_MIN) {
                postureFeedback = "â¬†ï¸ ì—‰ë©ì´ë¥¼ ì˜¬ë ¤ì£¼ì„¸ìš”";
            } else if (bodyAngle > PLANK_GOOD_MAX) {
                postureFeedback = "â¬‡ï¸ ì—‰ë©ì´ë¥¼ ë‚´ë ¤ì£¼ì„¸ìš”";
            } else {
                postureFeedback = "âœ… ì¢‹ì€ ìì„¸ì…ë‹ˆë‹¤!";
                isGoodPosture = true;
            }

            document.getElementById("feedback").innerText = postureFeedback;

            // í”Œë­í¬ ìƒíƒœ ë¨¸ì‹ 
            if (plankState === "WAITING") {
                if (isGoodPosture) {
                    plankState = "HOLDING";
                    holdStartTime = Date.now();
                    document.getElementById("status").innerText = "ğŸ”´ í”Œë­í¬ ìœ ì§€ ì‹œì‘!";
                    speak("í”Œë­í¬ ì‹œì‘!");
                } else {
                    document.getElementById("status").innerText = "â³ í”Œë­í¬ ìì„¸ë¥¼ ì¡ì•„ì£¼ì„¸ìš”";
                }
            } else if (plankState === "HOLDING") {
                // ìœ ì§€ ì‹œê°„ ê³„ì‚° ë° í‘œì‹œ
                totalHoldTime = Math.floor((Date.now() - holdStartTime) / 1000);
                document.getElementById("repCount").innerText = totalHoldTime + "ì´ˆ";
                document.getElementById("status").innerText = "ğŸ”´ ìœ ì§€ ì¤‘... " + postureFeedback;

                // 5ì´ˆë§ˆë‹¤ AI ë¶„ì„
                const now = Date.now();
                if (now - lastPlankCaptureTime > PLANK_CAPTURE_INTERVAL) {
                    lastPlankCaptureTime = now;
                    onPlankCapture();
                }

                // ìì„¸ ì´íƒˆ ì‹œ
                if (!isGoodPosture) {
                    // 3ì´ˆ ì •ë„ ìœ ì˜ˆ ì‹œê°„ ì—†ì´ ë°”ë¡œ í”¼ë“œë°± (ìŒì„±ì€ ì´ë¯¸ ì£¼ê³  ìˆìŒ)
                    // ì‹¬ê°í•œ ì´íƒˆ ì‹œì—ë§Œ ë¦¬ì…‹ (ê°ë„ê°€ ë„ˆë¬´ ë§ì´ ë²—ì–´ë‚¨)
                    if (bodyAngle < PLANK_GOOD_MIN - 20 || bodyAngle > PLANK_GOOD_MAX + 20) {
                        speak("ìì„¸ë¥¼ ë°”ë¡œ ì¡ì•„ì£¼ì„¸ìš”");
                    }
                }
            }
        }

        // ===== ìˆ„ë”í”„ë ˆìŠ¤ ë¡œì§ =====
        function checkVisiblePress(lm) {
            // ì–´ê¹¨(11,12), íŒ”ê¿ˆì¹˜(13,14), ì†ëª©(15,16)
            for (const i of [11, 12, 13, 14, 15, 16]) {
                if (!lm[i] || lm[i].y > 1 || lm[i].y < 0) return false;
                if (lm[i].visibility !== undefined && lm[i].visibility < VIS_TH) return false;
            }
            return true;
        }

        async function onPressComplete() {
            if (isProcessingFeedback || !capturedImage) return;
            isProcessingFeedback = true;
            repCount++;
            document.getElementById("repCount").innerText = repCount;
            document.getElementById("status").innerText = "ğŸ“¸ ë¶„ì„ ì¤‘...";
            document.getElementById("capturedImg").src = capturedImage;
            document.getElementById("capturedImg").style.display = "block";
            const fb = await sendImage(capturedImage, repCount);
            if (fb) {
                document.getElementById("feedback").innerText = fb;
                speak(fb);
                document.getElementById("status").innerText = "ğŸ”´ " + repCount + "íšŒ!";
                feedbackHistory.push({ rep: repCount, feedback: fb });
            }
            capturedImage = null; maxElbowAngle = 0; isProcessingFeedback = false;
        }

        function processShoulderPress(lm) {
            if (!checkVisiblePress(lm)) {
                document.getElementById("status").innerText = "âš ï¸ ìƒì²´ê°€ ë³´ì´ë„ë¡";
                return;
            }

            // ìƒì²´ ìŠ¤ì¼ˆë ˆí†¤
            const idx = [11, 12, 13, 14, 15, 16];
            const connections = [[11, 12], [11, 13], [12, 14], [13, 15], [14, 16]];
            drawSkeleton(lm, idx, connections);

            // íŒ”ê¿ˆì¹˜ ê°ë„ ê³„ì‚° (ì–‘ìª½ í‰ê· )
            const leftElbowAngle = calcAngle(lm[11], lm[13], lm[15]);
            const rightElbowAngle = calcAngle(lm[12], lm[14], lm[16]);
            const avgElbowAngle = (leftElbowAngle + rightElbowAngle) / 2;

            // ê°ë„ í‘œì‹œ
            ctx.fillStyle = "#ffcc00";
            ctx.font = "16px Arial";
            ctx.fillText(`Elbow: ${avgElbowAngle.toFixed(1)}Â°`, 10, 30);

            // ì†ëª©ì´ ì–´ê¹¨ë³´ë‹¤ ìœ„ì— ìˆëŠ”ì§€ í™•ì¸ (í”„ë ˆìŠ¤ ì™„ë£Œ íŒë‹¨ìš©)
            const wristAboveShoulder = (lm[15].y < lm[11].y) || (lm[16].y < lm[12].y);

            // ì‚¬ì´í´ ìƒíƒœ ë¨¸ì‹ 
            if (pressState === "READY") {
                if (avgElbowAngle < PRESS_READY_TH) {
                    document.getElementById("status").innerText = "â³ ì¤€ë¹„ ìì„¸ (íŒ”ê¿ˆì¹˜ êµ½í˜)";
                    document.getElementById("feedback").innerText = "íŒ”ê¿ˆì¹˜ë¥¼ í´ë©´ì„œ ìœ„ë¡œ ë°€ì–´ì£¼ì„¸ìš”";
                }
                if (avgElbowAngle > PRESS_READY_TH + 10) {
                    pressState = "PRESSING";
                    maxElbowAngle = avgElbowAngle;
                    document.getElementById("status").innerText = "â¬†ï¸ í”„ë ˆìŠ¤ ì¤‘...";
                }
            }
            else if (pressState === "PRESSING") {
                if (avgElbowAngle > maxElbowAngle) {
                    maxElbowAngle = avgElbowAngle;
                }
                if (avgElbowAngle > PRESS_TOP_TH && wristAboveShoulder) {
                    pressState = "TOP";
                    capturedImage = canvas.toDataURL("image/jpeg", 0.8);
                    document.getElementById("status").innerText = "ğŸ“¸ ìº¡ì²˜!";
                    document.getElementById("feedback").innerText = "âœ… ì¢‹ì•„ìš”! ì²œì²œíˆ ë‚´ë ¤ì£¼ì„¸ìš”";
                }
                // ì¶©ë¶„íˆ ì˜¬ë¦¬ì§€ ì•Šê³  ë‚´ë¦° ê²½ìš°
                if (avgElbowAngle < maxElbowAngle - 20 && maxElbowAngle < PRESS_TOP_TH) {
                    pressState = "READY";
                    maxElbowAngle = 0;
                    document.getElementById("status").innerText = "âŒ ë” ë†’ì´ ì˜¬ë ¤ì£¼ì„¸ìš”";
                }
            }
            else if (pressState === "TOP") {
                // íŒ”ì„ ë‚´ë¦¬ê¸° ì‹œì‘
                if (avgElbowAngle < PRESS_TOP_TH - 20) {
                    pressState = "LOWERING";
                    document.getElementById("status").innerText = "â¬‡ï¸ í•˜ê°• ì¤‘...";
                }
            }
            else if (pressState === "LOWERING") {
                if (avgElbowAngle < PRESS_READY_TH) {
                    pressState = "READY";
                    onPressComplete();
                }
            }
        }

        // ë©”ì¸ ì˜ˆì¸¡ ë£¨í”„
        function predict() {
            if (!poseLandmarker || !isRunning) return;
            const results = poseLandmarker.detectForVideo(video, frameIndex++);
            ctx.save();
            ctx.scale(-1, 1);
            ctx.translate(-canvas.width, 0);
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            ctx.restore();

            if (results.landmarks && results.landmarks[0]) {
                // ëœë“œë§ˆí¬ ì¢Œìš° ë°˜ì „ (ë¯¸ëŸ¬ë§)
                const raw = results.landmarks[0].map(l => ({ ...l, x: 1 - l.x }));
                const lm = smooth(raw);

                // ìš´ë™ íƒ€ì…ì— ë”°ë¼ ë¶„ê¸°
                if (currentExercise === "squat") {
                    processSquat(lm);
                } else if (currentExercise === "plank") {
                    processPlank(lm);
                } else if (currentExercise === "shoulder_press") {
                    processShoulderPress(lm);
                }
            }
            requestAnimationFrame(predict);
        }

        // ìš´ë™ ì‹œì‘
        window.startExercise = async function () {
            if (isRunning) return;
            document.getElementById("status").innerText = "ğŸ“· ë¡œë”©...";
            await initCamera();
            await initPose();

            // ìƒíƒœ ì´ˆê¸°í™”
            recordedChunks = [];
            feedbackHistory = [];
            repCount = 0;
            cycleState = "STANDING";
            minKneeAngle = 180;
            capturedImage = null;
            plankState = "WAITING";
            holdStartTime = null;
            totalHoldTime = 0;
            lastPlankCaptureTime = 0;
            pressState = "READY";
            maxElbowAngle = 0;
            smoothedLandmarks = null;

            // ë…¹í™” ì‹œì‘
            const stream = video.srcObject;
            mediaRecorder = new MediaRecorder(stream, { mimeType: 'video/webm' });
            mediaRecorder.ondataavailable = (e) => {
                if (e.data.size > 0) recordedChunks.push(e.data);
            };
            mediaRecorder.start();

            isRunning = true; startTime = new Date();
            document.getElementById("repCount").innerText = currentExercise === "plank" ? "0ì´ˆ" : "0";
            document.getElementById("startBtn").disabled = true;
            document.getElementById("stopBtn").disabled = false;
            document.getElementById("status").innerText = "ğŸ”´ ë…¹í™” ì¤‘...";
            predict();
        };

        // ìš´ë™ ì¢…ë£Œ
        window.stopExercise = async function () {
            isRunning = false;
            const duration = Math.round((new Date() - startTime) / 1000);
            document.getElementById("startBtn").disabled = false;
            document.getElementById("stopBtn").disabled = true;
            document.getElementById("status").innerText = "ğŸ’¾ ì €ì¥ ì¤‘...";

            // ë…¹í™” ì¤‘ì§€
            mediaRecorder.stop();
            await new Promise(resolve => mediaRecorder.onstop = resolve);

            const blob = new Blob(recordedChunks, { type: 'video/webm' });
            const reader = new FileReader();
            reader.readAsDataURL(blob);

            reader.onloadend = async () => {
                const videoBase64 = reader.result;

                // ì„¸ì…˜ ì €ì¥
                const sessionData = {
                    exercise: currentExercise,
                    reps: currentExercise === "squat" ? repCount : 0,
                    hold_time: currentExercise === "plank" ? totalHoldTime : 0,
                    duration: duration,
                    date: new Date().toLocaleString(),
                    feedbacks: feedbackHistory,
                    video: videoBase64
                };

                const res = await fetch("http://localhost:8003/save-session", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(sessionData)
                });
                const result = await res.json();

                document.getElementById("status").innerText = "âœ… ì €ì¥ ì™„ë£Œ!";
                addLogToUI(sessionData);
                console.log("ì €ì¥ ê²½ë¡œ:", result.saved_path);
            };
        };

        function addLogToUI(log) {
            const div = document.createElement("div");
            div.className = "log-item";
            if (log.exercise === "plank") {
                div.innerHTML = `<b>${log.exercise}</b>: ${log.hold_time}ì´ˆ ìœ ì§€ (${log.duration}ì´ˆ) - ${log.date}`;
            } else {
                div.innerHTML = `<b>${log.exercise}</b>: ${log.reps}íšŒ (${log.duration}ì´ˆ) - ${log.date}`;
            }
            document.getElementById("logList").prepend(div);
        }

        // ìœ íŠœë¸Œ ê²€ìƒ‰ ë° ë¡œë“œ (ê¸°ë³¸ ì˜ìƒ fallback í¬í•¨)
        const DEFAULT_VIDEOS = {
            squat: { videoId: "aclHkVaku9U", title: "ìŠ¤ì¿¼íŠ¸ ìì„¸ ê°€ì´ë“œ" },
            plank: { videoId: "pSHjTRCQxIw", title: "í”Œë­í¬ ìì„¸ ê°€ì´ë“œ" },
            shoulder_press: { videoId: "qEwKCR5JCog", title: "ìˆ„ë”í”„ë ˆìŠ¤ ìì„¸ ê°€ì´ë“œ" }
        };

        async function loadYouTubeVideo(exercise) {
            // ë¨¼ì € ê¸°ë³¸ ì˜ìƒ ì„¤ì • (API ì‹¤íŒ¨ ëŒ€ë¹„)
            const defaultVideo = DEFAULT_VIDEOS[exercise] || DEFAULT_VIDEOS.squat;
            document.getElementById("youtubeFrame").src = `https://www.youtube.com/embed/${defaultVideo.videoId}`;
            document.getElementById("videoTitle").innerText = defaultVideo.title;

            // APIë¡œ ë” ë‚˜ì€ ì˜ìƒ ê²€ìƒ‰ ì‹œë„
            try {
                const res = await fetch(`http://localhost:8003/search-youtube?exercise=${exercise}`);
                const data = await res.json();
                if (data.videos && data.videos.length > 0) {
                    const video = data.videos[0];
                    document.getElementById("youtubeFrame").src = `https://www.youtube.com/embed/${video.videoId}`;
                    document.getElementById("videoTitle").innerText = video.title;
                }
            } catch (e) {
                console.log("YouTube API ì‚¬ìš© ë¶ˆê°€, ê¸°ë³¸ ì˜ìƒ ì‚¬ìš©");
            }
        }

        // ìš´ë™ ì„ íƒ
        window.selectExercise = async function (type) {
            // ìš´ë™ ì¤‘ì—ëŠ” ë³€ê²½ ë¶ˆê°€
            if (isRunning) {
                alert("ìš´ë™ ì¤‘ì—ëŠ” ì¹´í…Œê³ ë¦¬ë¥¼ ë³€ê²½í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € ìš´ë™ì„ ì¢…ë£Œí•˜ì„¸ìš”.");
                return;
            }

            currentExercise = type;
            document.querySelectorAll(".exercise-btn").forEach(b => b.classList.remove("active"));
            document.querySelector(`[data-type="${type}"]`).classList.add("active");

            // UI ì—…ë°ì´íŠ¸
            if (type === "plank") {
                document.getElementById("repLabel").innerText = "ìœ ì§€ì‹œê°„";
                document.getElementById("repCount").innerText = "0ì´ˆ";
                document.getElementById("feedback").innerText = "í”Œë­í¬ ìì„¸ë¥¼ ì¡ìœ¼ë©´ AIê°€ ë¶„ì„í•©ë‹ˆë‹¤.";
            } else if (type === "shoulder_press") {
                document.getElementById("repLabel").innerText = "íšŸìˆ˜";
                document.getElementById("repCount").innerText = "0";
                document.getElementById("feedback").innerText = "ìˆ„ë”í”„ë ˆìŠ¤ë¥¼ ì‹œì‘í•˜ë©´ AIê°€ ìì„¸ë¥¼ ë¶„ì„í•©ë‹ˆë‹¤.";
            } else {
                document.getElementById("repLabel").innerText = "íšŸìˆ˜";
                document.getElementById("repCount").innerText = "0";
                document.getElementById("feedback").innerText = "ìŠ¤ì¿¼íŠ¸ë¥¼ ì‹œì‘í•˜ë©´ AIê°€ ìì„¸ë¥¼ ë¶„ì„í•©ë‹ˆë‹¤.";
            }

            await loadYouTubeVideo(type);
        };

        // LLM ì±„íŒ…
        window.sendChat = async function () {
            const input = document.getElementById("chatInput");
            const msg = input.value.trim();
            if (!msg) return;
            input.value = "";
            const chatBox = document.getElementById("chatBox");
            chatBox.innerHTML += `<div class="chat-user">ğŸ§‘ ${msg}</div>`;
            try {
                const res = await fetch("http://localhost:8003/chat", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ message: msg }) });
                const data = await res.json();
                chatBox.innerHTML += `<div class="chat-ai">ğŸ¤– ${data.response}</div>`;
            } catch (e) { chatBox.innerHTML += `<div class="chat-ai">ğŸ¤– ì˜¤ë¥˜ ë°œìƒ</div>`; }
            chatBox.scrollTop = chatBox.scrollHeight;
        };

        window.onload = async function () {
            try {
                const res = await fetch("http://localhost:8003/get-logs");
                const data = await res.json();
                data.logs.reverse().forEach(addLogToUI);
            } catch (e) { console.log("ë¡œê·¸ ë¡œë”© ì‹¤íŒ¨"); }
            await loadYouTubeVideo("squat");
        };
    </script>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #0f0f23 0%, #1a1a3e 100%);
            color: #eee;
            min-height: 100vh;
        }

        .header {
            text-align: center;
            padding: 15px;
            background: rgba(0, 0, 0, 0.3);
        }

        .header h1 {
            color: #00d4ff;
            font-size: 24px;
        }

        .main {
            display: grid;
            grid-template-columns: 250px 1fr;
            grid-template-rows: auto 1fr;
            gap: 15px;
            padding: 15px;
            height: calc(100vh - 70px);
        }

        .sidebar-left {
            grid-row: 1;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .sidebar-left-bottom {
            grid-row: 2;
            grid-column: 1;
        }

        .center-content {
            grid-row: 1 / 3;
            grid-column: 2;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .video-row {
            display: flex;
            gap: 15px;
        }

        .video-row .video-box {
            flex: 1;
        }

        .card {
            background: rgba(255, 255, 255, 0.08);
            border-radius: 12px;
            padding: 15px;
            backdrop-filter: blur(10px);
        }

        .card h3 {
            color: #00d4ff;
            font-size: 14px;
            margin-bottom: 10px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            padding-bottom: 8px;
        }

        .exercise-btn {
            display: block;
            width: 100%;
            padding: 12px;
            margin-bottom: 8px;
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: #fff;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }

        .exercise-btn:hover,
        .exercise-btn.active {
            background: #00d4ff;
            color: #000;
        }

        #chatBox {
            height: 150px;
            overflow-y: auto;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 10px;
            font-size: 12px;
        }

        .chat-user {
            color: #00ff88;
            margin-bottom: 5px;
        }

        .chat-ai {
            color: #ffcc00;
            margin-bottom: 5px;
        }

        #chatInput {
            width: 100%;
            padding: 8px;
            border: none;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
        }

        .video-box {
            position: relative;
            border-radius: 12px;
            overflow: hidden;
            background: #000;
        }

        .video-box canvas,
        .video-box iframe {
            width: 100%;
            height: 480px;
            display: block;
        }

        .video-label {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.7);
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 12px;
        }

        .controls {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .controls button {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
        }

        #startBtn {
            background: #00ff88;
            color: #000;
        }

        #stopBtn {
            background: #ff6b6b;
            color: #fff;
        }

        #startBtn:disabled,
        #stopBtn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .feedback-box {
            display: grid;
            grid-template-columns: 120px 1fr auto;
            gap: 15px;
            align-items: center;
        }

        #capturedImg {
            width: 120px;
            height: 90px;
            object-fit: cover;
            border-radius: 8px;
            border: 2px solid #ff6b35;
            display: none;
        }

        #feedback {
            font-size: 18px;
            color: #ffcc00;
        }

        .stats {
            display: flex;
            gap: 20px;
        }

        .stat {
            text-align: center;
        }

        .stat-value {
            font-size: 32px;
            font-weight: bold;
            color: #00ff88;
        }

        .stat-label {
            font-size: 12px;
            color: #aaa;
        }

        #status {
            color: #aaa;
            font-size: 14px;
        }

        .log-item {
            padding: 8px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 4px;
            margin-bottom: 5px;
            font-size: 12px;
        }

        #logList {
            max-height: calc(100vh - 200px);
            overflow-y: auto;
        }
    </style>
</head>

<body>
    <div class="header">
        <h1>ğŸ‹ï¸ ìš´ë™ ìì„¸ AI Agent</h1>
    </div>
    <div class="main">
        <!-- ì¢Œì¸¡: ìš´ë™ ì¹´í…Œê³ ë¦¬ + ì±„íŒ… -->
        <div class="sidebar-left">
            <div class="card">
                <h3>ğŸ“‹ ìš´ë™ ì¹´í…Œê³ ë¦¬</h3>
                <button class="exercise-btn active" data-type="squat" onclick="selectExercise('squat')">ğŸ‹ï¸ ìŠ¤ì¿¼íŠ¸</button>
                <button class="exercise-btn" data-type="plank" onclick="selectExercise('plank')">ğŸ§˜ í”Œë­í¬</button>
                <button class="exercise-btn" data-type="shoulder_press" onclick="selectExercise('shoulder_press')">ğŸ’ª
                    ìˆ„ë”í”„ë ˆìŠ¤</button>
            </div>
            <div class="card" style="flex:1;">
                <h3>ğŸ’¬ AI íŠ¸ë ˆì´ë„ˆ ì±„íŒ…</h3>
                <div id="chatBox"></div>
                <input type="text" id="chatInput" placeholder="ì§ˆë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”..."
                    onkeypress="if(event.key==='Enter')sendChat()">
            </div>
        </div>
        <!-- ì¢Œì¸¡ í•˜ë‹¨: ìš´ë™ ê¸°ë¡ -->
        <div class="sidebar-left-bottom">
            <div class="card" style="height:100%;">
                <h3>ğŸ“Š ìš´ë™ ê¸°ë¡</h3>
                <div id="logList"></div>
            </div>
        </div>
        <!-- ì¤‘ì•™: ìœ íŠœë¸Œ + ì›¹ìº  + í”¼ë“œë°± -->
        <div class="center-content">
            <div class="video-row">
                <div class="video-box">
                    <span class="video-label">ğŸ“º <span id="videoTitle">ê°€ì´ë“œ ì˜ìƒ</span></span>
                    <iframe id="youtubeFrame" src="" frameborder="0" allowfullscreen></iframe>
                </div>
                <div class="video-box">
                    <span class="video-label">ğŸ“· ë‚´ ì›¹ìº </span>
                    <video id="video" playsinline style="display:none;"></video>
                    <canvas id="canvas"></canvas>
                </div>
            </div>
            <div class="card">
                <div class="feedback-box">
                    <img id="capturedImg" src="">
                    <div>
                        <div id="feedback">ìŠ¤ì¿¼íŠ¸ë¥¼ ì‹œì‘í•˜ë©´ AIê°€ ìì„¸ë¥¼ ë¶„ì„í•©ë‹ˆë‹¤.</div>
                        <div id="status" style="margin-top:5px;">ëŒ€ê¸° ì¤‘...</div>
                    </div>
                    <div class="stats">
                        <div class="stat">
                            <div class="stat-value" id="repCount">0</div>
                            <div class="stat-label" id="repLabel">íšŸìˆ˜</div>
                        </div>

                    </div>
                </div>
                <div class="controls">
                    <button id="startBtn" onclick="startExercise()">â–¶ï¸ ìš´ë™ ì‹œì‘</button>
                    <button id="stopBtn" onclick="stopExercise()" disabled>â¹ï¸ ìš´ë™ ì¢…ë£Œ</button>
                </div>
            </div>
        </div>
    </div>
</body>

</html>